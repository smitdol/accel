#include "MyAccelStepper.h"

long MyAccelStepper::ccache[514] = {39028,23417,18213,15411,13598,12303,11318,10538,9899,9364,8907,8511,8164,7856,7580,7332,7106,6900,6711,6537,6375,6225,6085,5954,5832,5716,5607,5504,5407,5315,5227,5143,5063,4987,4914,4845,4778,4714,4652,4593,4536,4481,4428,4376,4327,4279,4233,4188,4145,4103,4062,4022,3984,3946,3910,3875,3840,3807,3774,3742,3711,3681,3651,3622,3594,3566,3540,3513,3488,3462,3438,3414,3390,3367,3344,3322,3300,3279,3258,3237,3217,3197,3178,3159,3140,3122,3103,3086,3068,3051,3034,3017,3001,2985,2969,2954,2938,2923,2908,2894,2879,2865,2851,2837,2823,2810,2797,2784,2771,2758,2746,2733,2721,2709,2697,2686,2674,2663,2651,2640,2629,2618,2608,2597,2587,2576,2566,2556,2546,2536,2527,2517,2507,2498,2489,2480,2470,2461,2453,2444,2435,2426,2418,2409,2401,2393,2385,2376,2368,2361,2353,2345,2337,2330,2322,2315,2307,2300,2293,2285,2278,2271,2264,2257,2250,2244,2237,2230,2223,2217,2210,2204,2198,2191,2185,2179,2172,2166,2160,2154,2148,2142,2136,2131,2125,2119,2113,2108,2102,2097,2091,2086,2080,2075,2069,2064,2059,2054,2049,2043,2038,2033,2028,2023,2018,2013,2008,2004,1999,1994,1989,1985,1980,1975,1971,1966,1961,1957,1952,1948,1944,1939,1935,1931,1926,1922,1918,1913,1909,1905,1901,1897,1893,1889,1885,1881,1877,1873,1869,1865,1861,1857,1853,1850,1846,1842,1838,1834,1831,1827,1823,1820,1816,1813,1809,1806,1802,1799,1795,1792,1788,1785,1781,1778,1775,1771,1768,1765,1761,1758,1755,1752,1748,1745,1742,1739,1736,1732,1729,1726,1723,1720,1717,1714,1711,1708,1705,1702,1699,1696,1693,1690,1687,1685,1682,1679,1676,1673,1670,1668,1665,1662,1659,1657,1654,1651,1648,1646,1643,1640,1638,1635,1633,1630,1627,1625,1622,1620,1617,1615,1612,1610,1607,1605,1602,1600,1597,1595,1592,1590,1587,1585,1583,1580,1578,1576,1573,1571,1569,1566,1564,1562,1559,1557,1555,1553,1550,1548,1546,1544,1541,1539,1537,1535,1533,1531,1528,1526,1524,1522,1520,1518,1516,1514,1512,1510,1507,1505,1503,1501,1499,1497,1495,1493,1491,1489,1487,1485,1483,1481,1479,1478,1476,1474,1472,1470,1468,1466,1464,1462,1460,1459,1457,1455,1453,1451,1449,1447,1446,1444,1442,1440,1438,1437,1435,1433,1431,1430,1428,1426,1424,1423,1421,1419,1417,1416,1414,1412,1411,1409,1407,1406,1404,1402,1401,1399,1397,1396,1394,1392,1391,1389,1388,1386,1384,1383,1381,1380,1378,1377,1375,1373,1372,1370,1369,1367,1366,1364,1363,1361,1360,1358,1357,1355,1354,1352,1351,1349,1348,1346,1345,1343,1342,1340,1339,1338,1336,1335,1333,1332,1330,1329,1328,1326,1325,1323,1322,1321,1319,1318,1316,1315,1314,1312,1311,1310,1308,1307,1306,1304,1303,1302,1300,1299,1298,1296,1295,1294,1292,1291,1290,1289,1287,1286,1285,1283,1282,1281,1280,1278,1277,1276,1275};
MyAccelStepper::MyAccelStepper(uint8_t interface, uint8_t pin1, uint8_t pin2, uint8_t pin3, uint8_t pin4, bool enable):
AccelStepper(interface, pin1, pin2, pin3, pin4, enable)
{

};

unsigned long  MyAccelStepper::computeNewSpeed() 
{
    long distanceTo = distanceToGo(); // +ve is clockwise from curent location

    long stepsToStop = (long)((speed() * speed()) / (2.0 * acceleration())); // Equation 16

    if (distanceTo == 0)// && stepsToStop <= 1)
    {
	// We are at the target and its time to stop
      setSpeed(0);
      return _stepInterval;
    }

    if (distanceTo > 0)
    {
      // We are anticlockwise from the target
      // Need to go clockwise from here, maybe decelerate now
      if (_n > 0)
      {
          // Currently accelerating, need to decel now? Or maybe going the wrong way?
          if ((stepsToStop >= distanceTo) || _direction == DIRECTION_CCW)
            _n = -stepsToStop; // Start deceleration
      }
      else if (_n < 0)
      {
          // Currently decelerating, need to accel again?
          if ((stepsToStop < distanceTo) && _direction == DIRECTION_CW)
            _n = -_n; // Start accceleration
      }
    }
    else if (distanceTo < 0)
    {
      // We are clockwise from the target
      // Need to go anticlockwise from here, maybe decelerate
      if (_n > 0)
      {
          // Currently accelerating, need to decel now? Or maybe going the wrong way?
          if ((stepsToStop >= -distanceTo) || _direction == DIRECTION_CW)
            _n = -stepsToStop; // Start deceleration
      }
      else if (_n < 0)
      {
          // Currently decelerating, need to accel again?
          if ((stepsToStop < -distanceTo) && _direction == DIRECTION_CCW)
            _n = -_n; // Start accceleration
      }
    }
    long idx = min(abs(_n), 513);
    _cn = ccache[idx];
    _n++;
    if (_direction == DIRECTION_CCW) {
      _cn = -_cn;
    }
    _stepInterval = _cn;
    setSpeed(1000000.0 / _cn);
    return _stepInterval;
}
